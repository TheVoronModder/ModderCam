# ModderCam (Standalone) â€” Klipper Macros
[respond]
default_type: echo

[save_variables]
filename: ~/printer_data/config/moddercam/state_vars.cfg

[gcode_macro MODDERCAM_VARS]
variable_snapshot_url: "http://127.0.0.1:8080/?action=snapshot"
variable_stream_url:   "http://127.0.0.1:8080/?action=stream"
gcode:
  RESPOND TYPE=echo MSG="ModderCam URLs set."

[gcode_shell_command MODDERCAM_SNAPSHOT_CMD]
command: bash /home/pi/printer_data/config/scripts/snapshot.sh
timeout: 10.0
verbose: False

[gcode_shell_command MODDERCAM_PING_CMD]
command: bash /home/pi/printer_data/config/scripts/streamctl.sh ping
timeout: 5.0
verbose: False

[gcode_macro MODDERCAM_SNAPSHOT]
description: "Save a snapshot to /printer_data/media/moddercam"
gcode:
  {% set url = printer["gcode_macro MODDERCAM_VARS"].snapshot_url %}
  SET_GCODE_VARIABLE MACRO=MODDERCAM_VARS VARIABLE=snapshot_url VALUE="{url}"
  RESPOND TYPE=echo MSG="Snapshot from {url}"
  RUN_SHELL_COMMAND CMD=MODDERCAM_SNAPSHOT_CMD PARAMS="{url}"

[gcode_macro MODDERCAM_STREAM_ON]
description: "Ping stream URL (moddercam service)"
gcode:
  RUN_SHELL_COMMAND CMD=MODDERCAM_PING_CMD

[gcode_macro MODDERCAM_STREAM_OFF]
description: "Note to stop service if desired"
gcode:
  RESPOND TYPE=echo MSG="Use: sudo systemctl stop moddercam"
